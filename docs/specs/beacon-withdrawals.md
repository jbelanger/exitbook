---
last_verified: 2026-01-03
status: canonical
---

# Beacon Withdrawals (Ethereum) Specification

WARNING: Code is law. If this document disagrees with implementation, update the spec to match code.

Defines how Exitbook ingests, normalizes, classifies, and reports Ethereum consensus layer (beacon chain) withdrawals.

## Why This Exists

Beacon chain withdrawals (post-Shanghai, April 2023) move ETH from the consensus layer to execution-layer addresses without a normal transaction hash. Standard transaction APIs do not include these events. If we ignore them, balances and cost basis are wrong for:

- Validator withdrawal addresses (solo stakers)
- Staking pool contracts
- EOAs used as withdrawal addresses

For these addresses, missing withdrawals creates systematic balance mismatches and tax/accounting errors. This spec ensures withdrawals are ingested and classified deterministically so Ethereum balances are correct.

## Quick Reference

| Concept                | Key Rule                                                                                           |
| ---------------------- | -------------------------------------------------------------------------------------------------- |
| `beacon_withdrawal`    | EVM transaction type for consensus layer withdrawals (Ethereum only).                              |
| `BEACON_CHAIN_ADDRESS` | Synthetic `from` address: `0x0000000000000000000000000000000000000000`.                            |
| `eventId`              | SHA-256 over withdrawal fields (index, validator, address, amountWei, block, timestamp, currency). |
| Tax classification     | `< 32 ETH` => `staking/reward`; `>= 32 ETH` => `staking/deposit` + warning note.                   |

## Goals

- Include beacon withdrawals in Ethereum balances and derived accounting.
- Normalize withdrawals into the same EVM transaction pipeline used by other transfers.
- Preserve sufficient metadata for dedupe, resumability, and user review.
- Warn when withdrawals cannot be fetched.

## Non-Goals

- Support for non-Ethereum chains or non-Etherscan providers.
- Exact reward vs principal decomposition for full withdrawals.
- User-facing prompts or report banners beyond existing warnings.

## Definitions

### Beacon Withdrawal (Normalized EVM Transaction)

Consensus layer withdrawals are represented as `EvmTransaction` with `type = 'beacon_withdrawal'`:

```ts
{
  type: 'beacon_withdrawal',
  id: `beacon-withdrawal-${withdrawalIndex}`, // synthetic
  eventId: string, // SHA-256 over withdrawal fields
  from: '0x0000000000000000000000000000000000000000',
  to: '<recipient address (lowercase)>',
  amount: '<wei string>',
  currency: 'ETH',
  blockHeight: number,
  blockId?: undefined, // Etherscan does not provide
  timestamp: number, // milliseconds
  status: 'success',
  gasPrice: '0',
  gasUsed: '0',
  feeAmount: '0',
  feeCurrency: 'ETH',
  withdrawalIndex: string,
  validatorIndex: string
}
```

### Consensus Withdrawal Note

The processor emits a note on processed transactions to preserve tax and audit context:

```ts
{
  type: 'consensus_withdrawal',
  severity: 'info' | 'warning',
  message: string,
  metadata: {
    amount: string, // ETH
    needsReview: boolean,
    taxClassification: 'taxable (income)' | 'non-taxable (principal return)',
    withdrawalIndex?: string,
    validatorIndex?: string,
    blockHeight?: number
  }
}
```

## Behavioral Rules

### Import Scope

- Only Ethereum imports include `beacon_withdrawal` in the deterministic transaction type order.
- Other EVM chains import `normal`, `internal`, `token` only.

### Provider Support and API Keys

- Only providers that declare `supportedTransactionTypes` including `beacon_withdrawal` are used.
- Etherscan is currently the only provider with this capability.
- If the Etherscan API key is missing, the provider is not registered and withdrawals are treated as unsupported.

### Mapping From Etherscan

- Etherscan returns withdrawal `amount` in Gwei; it is converted to Wei during mapping.
- `from` is always `BEACON_CHAIN_ADDRESS`.
- `id` is synthetic: `beacon-withdrawal-{withdrawalIndex}`.
- `eventId` is generated by hashing all withdrawal fields to ensure uniqueness.
- `feeAmount`, `gasPrice`, and `gasUsed` are all `'0'`.

### Pagination and Streaming

- Etherscan uses `page` + `offset` with the constraint `page * offset <= 10,000`.
- The client fetches pages 1-10 at `offset = 1000`, then restarts at page 1 with `startblock` set to the last withdrawal's block (inclusive) to continue streaming.
- The streaming adapter deduplicates overlapping items via `eventId` within a rolling window.

### Classification Rules

- Beacon withdrawals are always treated as native currency inflows.
- Classification uses normalized ETH amounts (Wei -> ETH via chain decimals).
- Threshold rule:
  - `< 32 ETH` => operation `{ category: 'staking', type: 'reward' }` with `consensus_withdrawal` note (info).
  - `>= 32 ETH` => operation `{ category: 'staking', type: 'deposit' }` with `consensus_withdrawal` note (warning) and `needsReview: true`.

### Import Status and Reporting

- If no provider support is available, the importer yields a `beacon_withdrawal` cursor with `fetchStatus: 'skipped'` and a warning.
- If provider fetch fails, it yields a `beacon_withdrawal` cursor with `fetchStatus: 'failed'` and a warning.
- If no withdrawals are found, the importer yields a `beacon_withdrawal` cursor with `lastTransactionId = 'NO_WITHDRAWALS'`.
- The balance CLI reads `accounts.lastCursor['beacon_withdrawal']` to display whether withdrawals were included.

## Data Model

### Raw Transactions

Raw EVM transactions store beacon withdrawals with:

- `transactionTypeHint: 'beacon_withdrawal'`
- `blockchainTransactionHash: 'beacon-withdrawal-{withdrawalIndex}'`
- `eventId` computed from withdrawal fields

### Processed Transactions

Processed transactions include:

- `operation` classification per rules above
- `notes` containing the `consensus_withdrawal` metadata

## Pipeline / Flow

```mermaid
graph TD
  A[Etherscan txsBeaconWithdrawal] --> B[Map Gwei->Wei, normalize, eventId]
  B --> C[raw_transactions (type=beacon_withdrawal)]
  C --> D[EVM processor fund flow]
  D --> E[operation + notes]
  E --> F[balances/reporting]
```

## Invariants

- `type` is always `beacon_withdrawal` for consensus withdrawals.
- `from` is always `0x0000000000000000000000000000000000000000`.
- `feeAmount`, `gasPrice`, and `gasUsed` are always `'0'`.
- `status` is always `'success'`.
- `eventId` is deterministic over the full withdrawal field set.

## Edge Cases & Gotchas

- Address with zero withdrawals: import completes with a cursor marker and no raw transactions.
- Large validator addresses (10k+ withdrawals): pagination resets at the 10k boundary; duplicates are expected and deduped.
- Missing Etherscan API key is indistinguishable from no provider support in import status; both are reported as "provider does not support beacon withdrawals."

## Known Limitations (Current Implementation)

- Etherscan-only; other providers and direct beacon node APIs are not used.
- Classification uses the 32 ETH heuristic and cannot split rewards inside full withdrawals.
- No interactive prompt or report banner is emitted; only warnings and cursor metadata are recorded.

## Related Specs

- `docs/specs/accounts-and-imports.md` (cursor storage, streaming imports)

---

Last updated: 2026-01-03
